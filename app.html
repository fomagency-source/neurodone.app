<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0a0a0f">
  <title>NEURODONE</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/icon-192.svg">
  <style>
    :root {
      --bg-main: #0a0a0f;
      --bg-card: #14141c;
      --bg-elevated: #1c1c28;
      --border-subtle: #2a2a3c;
      --text-primary: #f5f5f7;
      --text-secondary: #a1a1aa;
      --text-muted: #6b6b76;
      --accent-primary: #6366f1;
      --accent-glow: #818cf8;
      --accent-success: #34d399;
      --accent-warning: #fbbf24;
      --accent-danger: #f87171;
      --accent-purple: #8b5cf6;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --safe-top: env(safe-area-inset-top, 20px);
      --safe-bottom: env(safe-area-inset-bottom, 20px);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; overflow: hidden; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-main); color: var(--text-primary); }
    #root { height: 100%; }
    input, button, textarea, select { font-family: inherit; border: none; outline: none; }
    
    @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes confetti { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(105vh) rotate(720deg); opacity: 0; } }
    @keyframes breathe { 0%, 100% { box-shadow: 0 0 20px rgba(139,92,246,0.4); } 50% { box-shadow: 0 0 40px rgba(139,92,246,0.7); } }
    @keyframes thinking { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
    .slideUp { animation: slideUp 0.3s ease; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;

    const generateId = () => Math.random().toString(36).substr(2, 9);
    const getDaysUntil = (date) => { const now = new Date(); now.setHours(0,0,0,0); const target = new Date(date); target.setHours(0,0,0,0); return Math.ceil((target - now) / (1000 * 60 * 60 * 24)); };
    const getDeadlineDisplay = (date) => { const days = getDaysUntil(date); if (days < 0) return { text: `${Math.abs(days)}d overdue`, color: 'var(--accent-danger)' }; if (days === 0) return { text: 'Today', color: 'var(--accent-primary)' }; if (days === 1) return { text: 'Tomorrow', color: 'var(--accent-glow)' }; if (days <= 7) return { text: `${days} days`, color: 'var(--text-secondary)' }; return { text: `${days} days`, color: 'var(--text-muted)' }; };
    const formatDateShort = (date) => new Date(date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    const isToday = (date) => new Date(date).toDateString() === new Date().toDateString();
    const isSameDay = (d1, d2) => new Date(d1).toDateString() === new Date(d2).toDateString();
    const setDateAt = (days) => { const d = new Date(); d.setDate(d.getDate() + days); d.setHours(23,59,0,0); return d.toISOString(); };
    
    const deadlineFromText = (text) => {
      const l = text?.toLowerCase() || '';
      if (l.includes('today') || l.includes('tonight')) return setDateAt(0);
      if (l.includes('tomorrow')) return setDateAt(1);
      const days = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
      for (let i = 0; i < days.length; i++) {
        if (l.includes(days[i])) { const d = new Date(); const diff = (i - d.getDay() + 7) % 7 || 7; return setDateAt(diff); }
      }
      if (l.includes('week')) return setDateAt(7);
      return setDateAt(0);
    };

    // =============================================
    // GEMINI API
    // =============================================
    const GeminiAPI = {
      async generateChunks(taskName) {
        try {
          const res = await fetch('/api/ai', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'generateChunks', data: { taskName } }) });
          const result = await res.json();
          if (result.success && Array.isArray(result.data)) return result.data.map(name => ({ id: generateId(), name, completed: false }));
        } catch (e) { console.error('Chunks error:', e); }
        return LocalParser.generateChunks(taskName);
      },
      async parseVoice(transcript) {
        try {
          const res = await fetch('/api/ai', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'parseVoice', data: { transcript } }) });
          const result = await res.json();
          console.log('Parse result:', result);
          if (result.success && Array.isArray(result.data) && result.data.length > 0) return result.data;
        } catch (e) { console.error('Parse error:', e); }
        return [{ name: LocalParser.cleanTaskName(transcript), deadline: 'today' }];
      },
      async coachSession(transcript) {
        try {
          const res = await fetch('/api/ai', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'coachSession', data: { transcript } }) });
          const result = await res.json();
          console.log('Coach result:', result);
          if (result.success && result.data) return result.data;
        } catch (e) { console.error('Coach error:', e); }
        return null;
      }
    };

    const LocalParser = {
      generateChunks(taskName) {
        const n = taskName.toLowerCase();
        if (n.includes('call') || n.includes('meet')) return [{ id: generateId(), name: 'Prepare points', completed: false }, { id: generateId(), name: 'Make call', completed: false }, { id: generateId(), name: 'Follow up', completed: false }];
        if (n.includes('shop') || n.includes('buy')) return [{ id: generateId(), name: 'Make list', completed: false }, { id: generateId(), name: 'Go shopping', completed: false }, { id: generateId(), name: 'Put away', completed: false }];
        return [{ id: generateId(), name: 'Start (2 min)', completed: false }, { id: generateId(), name: 'Main work', completed: false }, { id: generateId(), name: 'Finish up', completed: false }];
      },
      cleanTaskName(text) {
        return text.replace(/^(hey|hi|ok|so|um|uh|like|please|i need to|i want to|i have to)\s*/gi, '').replace(/\s+/g, ' ').trim().replace(/^./, c => c.toUpperCase());
      }
    };

    // =============================================
    // ICONS
    // =============================================
    const Icons = {
      Mic: ({s=24}) => <svg width={s} height={s} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>,
      Check: ({s=18}) => <svg width={s} height={s} fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round"><polyline points="4 12 9 17 20 6"/></svg>,
      Calendar: ({s=20}) => <svg width={s} height={s} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
      Folder: ({s=20}) => <svg width={s} height={s} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>,
      User: ({s=24}) => <svg width={s} height={s} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
      X: ({s=24}) => <svg width={s} height={s} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
      Plus: ({s=20}) => <svg width={s} height={s} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
      Edit: ({s=18}) => <svg width={s} height={s} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
      ChevronRight: ({s=20}) => <svg width={s} height={s} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><polyline points="9 18 15 12 9 6"/></svg>,
      ChevronLeft: ({s=20}) => <svg width={s} height={s} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><polyline points="15 18 9 12 15 6"/></svg>,
      ChevronDown: ({s=16}) => <svg width={s} height={s} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><polyline points="6 9 12 15 18 9"/></svg>,
      Zap: ({s=20}) => <svg width={s} height={s} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
      Clock: ({s=16}) => <svg width={s} height={s} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
      Trash: ({s=18}) => <svg width={s} height={s} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
      MoreV: ({s=20}) => <svg width={s} height={s} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>,
      Brain: ({s=20}) => <svg width={s} height={s} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24A2.5 2.5 0 0 1 9.5 2"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24A2.5 2.5 0 0 0 14.5 2"/></svg>,
      Undo: ({s=18}) => <svg width={s} height={s} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>,
      Wand: ({s=20}) => <svg width={s} height={s} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M15 4V2M15 16v-2M8 9h2M20 9h2M17.8 11.8L19 13M17.8 6.2L19 5M3 21l9-9M12.2 6.2L11 5"/></svg>,
    };

    // =============================================
    // COMPONENTS
    // =============================================
    const Celebration = ({ show, onDone }) => {
      useEffect(() => { if (show) { const t = setTimeout(onDone, 2000); return () => clearTimeout(t); } }, [show, onDone]);
      if (!show) return null;
      const colors = ['#6366f1','#818cf8','#34d399','#fbbf24','#f87171','#ec4899'];
      const confetti = Array.from({length:50}, () => ({ left: Math.random()*100, delay: Math.random()*0.5, color: colors[Math.floor(Math.random()*colors.length)], size: 6+Math.random()*8 }));
      return <div style={{position:'fixed',inset:0,zIndex:9999,pointerEvents:'none'}}>{confetti.map((c,i) => <div key={i} style={{position:'absolute',left:`${c.left}%`,top:-20,width:c.size,height:c.size,background:c.color,borderRadius:Math.random()>0.5?'50%':'2px',animation:`confetti 2.5s ease-out ${c.delay}s forwards`}} />)}<div style={{position:'absolute',top:'40%',left:'50%',transform:'translate(-50%,-50%)',textAlign:'center'}}><div style={{fontSize:'72px'}}>üéâ</div><div style={{fontSize:'24px',fontWeight:'700',color:'var(--accent-success)'}}>Done!</div></div></div>;
    };

    const Toast = ({ message, onClose }) => {
      useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, [onClose]);
      return <div className="slideUp" style={{position:'fixed',bottom:'160px',left:'20px',right:'20px',background:'var(--bg-elevated)',borderRadius:'var(--radius-md)',padding:'14px 16px',boxShadow:'0 8px 32px rgba(0,0,0,0.4)',zIndex:100,textAlign:'center'}}>{message}</div>;
    };

    // AI Coach Result Modal
    const AICoachResult = ({ result, onConfirm, onClose }) => {
      if (!result) return null;
      return (
        <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.85)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:1000,padding:'20px'}} onClick={onClose}>
          <div className="slideUp" style={{background:'var(--bg-card)',borderRadius:'var(--radius-lg)',width:'100%',maxWidth:'400px',maxHeight:'80vh',overflow:'auto',padding:'24px'}} onClick={e=>e.stopPropagation()}>
            <div style={{display:'flex',alignItems:'center',gap:'12px',marginBottom:'20px'}}>
              <div style={{width:'48px',height:'48px',borderRadius:'50%',background:'linear-gradient(135deg,var(--accent-purple),var(--accent-primary))',display:'flex',alignItems:'center',justifyContent:'center'}}><Icons.Brain s={24}/></div>
              <div><h3 style={{fontSize:'18px',fontWeight:'600'}}>AI Coach</h3><p style={{fontSize:'13px',color:'var(--text-muted)'}}>Found {result.tasks?.length || 0} tasks</p></div>
            </div>
            
            {result.encouragement && <div style={{padding:'14px',background:'var(--accent-purple)15',borderRadius:'var(--radius-md)',marginBottom:'20px',borderLeft:'3px solid var(--accent-purple)'}}><p style={{fontSize:'14px',fontStyle:'italic'}}>"{result.encouragement}"</p></div>}
            
            <div style={{display:'flex',flexDirection:'column',gap:'10px',marginBottom:'20px'}}>
              {result.tasks?.map((task, i) => (
                <div key={i} style={{padding:'12px',background:'var(--bg-elevated)',borderRadius:'var(--radius-md)'}}>
                  <div style={{fontWeight:'600',marginBottom:'4px'}}>{task.name}</div>
                  <div style={{fontSize:'12px',color:'var(--accent-primary)',marginBottom:'6px'}}>üìÖ {task.deadline}</div>
                  <div style={{fontSize:'12px',color:'var(--text-muted)'}}>{task.chunks?.length || 0} steps planned</div>
                </div>
              ))}
            </div>
            
            <div style={{display:'flex',gap:'12px'}}>
              <button onClick={onClose} style={{flex:1,padding:'14px',background:'var(--bg-elevated)',borderRadius:'var(--radius-md)',color:'var(--text-secondary)',cursor:'pointer'}}>Cancel</button>
              <button onClick={onConfirm} style={{flex:2,padding:'14px',background:'linear-gradient(135deg,var(--accent-purple),var(--accent-primary))',borderRadius:'var(--radius-md)',color:'white',fontWeight:'600',cursor:'pointer'}}>Add All ‚ú®</button>
            </div>
          </div>
        </div>
      );
    };

    const DeadlinePicker = ({ current, onSelect, onClose }) => {
      const opts = [{label:'Today',days:0},{label:'Tomorrow',days:1},{label:'In 3 days',days:3},{label:'Next week',days:7}];
      return (
        <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.7)',display:'flex',alignItems:'flex-end',justifyContent:'center',zIndex:1000}} onClick={onClose}>
          <div className="slideUp" style={{background:'var(--bg-card)',borderRadius:'20px 20px 0 0',width:'100%',maxWidth:'400px',padding:'24px',paddingBottom:'calc(24px + var(--safe-bottom))'}} onClick={e=>e.stopPropagation()}>
            <h3 style={{fontSize:'18px',fontWeight:'600',marginBottom:'16px'}}>When is this due?</h3>
            <div style={{display:'flex',flexDirection:'column',gap:'8px'}}>
              {opts.map((o,i) => <button key={i} onClick={()=>onSelect(setDateAt(o.days))} style={{padding:'16px',background:'var(--bg-elevated)',borderRadius:'var(--radius-md)',color:'var(--text-primary)',fontSize:'16px',cursor:'pointer',textAlign:'left'}}>{o.label}</button>)}
            </div>
          </div>
        </div>
      );
    };

    const TaskCard = ({ task, onToggleChunk, onComplete, onDelete, onUpdateDeadline, onUpdateChunks }) => {
      const [expanded, setExpanded] = useState(false);
      const [showDeadline, setShowDeadline] = useState(false);
      const [regenerating, setRegenerating] = useState(false);
      
      const done = task.chunks.filter(c=>c.completed).length;
      const total = task.chunks.length;
      const progress = total > 0 ? (done/total)*100 : 0;
      const allDone = total > 0 && done === total;
      const dl = getDeadlineDisplay(task.deadline);

      const handleRegenerate = async () => {
        setRegenerating(true);
        const newChunks = await GeminiAPI.generateChunks(task.name);
        onUpdateChunks(task.id, newChunks);
        setRegenerating(false);
      };

      return (
        <>
          <div style={{background:'var(--bg-card)',borderRadius:'var(--radius-lg)',padding:'16px',marginBottom:'12px',border:`1px solid ${task.completed||allDone?'var(--accent-success)40':'var(--border-subtle)'}`,opacity:task.completed?0.6:1}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'8px'}}>
              <div style={{flex:1}}>
                <div style={{fontSize:'11px',fontWeight:'600',color:'var(--accent-primary)',textTransform:'uppercase',marginBottom:'4px'}}>{task.project}</div>
                <h3 style={{fontSize:'15px',fontWeight:'600',textDecoration:task.completed?'line-through':'none',lineHeight:1.4}}>{task.name}</h3>
              </div>
              <button onClick={()=>onDelete(task.id)} style={{background:'none',color:'var(--text-muted)',cursor:'pointer',padding:'4px'}}><Icons.Trash s={16}/></button>
            </div>
            
            {!task.completed && <button onClick={()=>setShowDeadline(true)} style={{display:'inline-flex',alignItems:'center',gap:'6px',padding:'6px 12px',background:'var(--bg-elevated)',borderRadius:'20px',fontSize:'13px',color:dl.color,cursor:'pointer',marginBottom:'12px'}}><Icons.Clock s={14}/>{dl.text}</button>}
            
            <div style={{height:'4px',background:'var(--bg-elevated)',borderRadius:'2px',overflow:'hidden',marginBottom:'12px'}}><div style={{height:'100%',width:`${progress}%`,background:allDone?'var(--accent-success)':'var(--accent-primary)',transition:'width 0.3s'}}/></div>
            
            <button onClick={()=>setExpanded(!expanded)} style={{display:'flex',alignItems:'center',justifyContent:'space-between',width:'100%',padding:'8px 0',background:'none',color:'var(--text-secondary)',cursor:'pointer',fontSize:'13px'}}>
              <span>{done}/{total} steps</span>
              <span style={{transform:expanded?'rotate(180deg)':'rotate(0)',transition:'transform 0.2s'}}><Icons.ChevronDown/></span>
            </button>
            
            {expanded && <div style={{paddingTop:'8px'}}>
              {task.chunks.map((c,i)=>(
                <div key={c.id} onClick={()=>!task.completed&&onToggleChunk(task.id,c.id)} style={{display:'flex',alignItems:'center',gap:'12px',padding:'12px 0',borderBottom:i<total-1?'1px solid var(--border-subtle)':'none',cursor:'pointer'}}>
                  <div style={{width:'24px',height:'24px',borderRadius:'6px',border:c.completed?'none':'2px solid var(--border-subtle)',background:c.completed?'var(--accent-success)':'transparent',display:'flex',alignItems:'center',justifyContent:'center',flexShrink:0}}>{c.completed&&<Icons.Check s={14}/>}</div>
                  <span style={{fontSize:'14px',textDecoration:c.completed?'line-through':'none',color:c.completed?'var(--text-muted)':'var(--text-primary)'}}>{c.name}</span>
                </div>
              ))}
              
              {!task.completed && (
                <button onClick={handleRegenerate} disabled={regenerating} style={{display:'flex',alignItems:'center',gap:'8px',padding:'10px 14px',marginTop:'12px',background:'linear-gradient(135deg, var(--accent-purple), var(--accent-primary))',borderRadius:'var(--radius-md)',color:'white',fontSize:'13px',cursor:'pointer',opacity:regenerating?0.7:1}}>
                  {regenerating ? <div style={{width:'16px',height:'16px',border:'2px solid white',borderTopColor:'transparent',borderRadius:'50%',animation:'spin 1s linear infinite'}}/> : <Icons.Wand s={16}/>}
                  {regenerating ? 'Thinking...' : 'AI: New steps'}
                </button>
              )}
              
              {allDone && !task.completed && <button onClick={()=>onComplete(task.id)} style={{width:'100%',padding:'14px',marginTop:'12px',background:'var(--accent-success)',borderRadius:'var(--radius-md)',color:'white',fontSize:'15px',fontWeight:'600',cursor:'pointer'}}>Complete üéâ</button>}
            </div>}
          </div>
          {showDeadline && <DeadlinePicker current={task.deadline} onSelect={d=>{onUpdateDeadline(task.id,d);setShowDeadline(false);}} onClose={()=>setShowDeadline(false)}/>}
        </>
      );
    };

    const CalendarView = ({ tasks, selectedDate, onSelectDate }) => {
      const getWeekDays = () => { const days = []; const s = new Date(); s.setDate(s.getDate()-s.getDay()); for(let i=0;i<7;i++){const d=new Date(s);d.setDate(d.getDate()+i);days.push(d);} return days; };
      const getCount = d => tasks.filter(t=>!t.completed&&isSameDay(t.deadline,d)).length;
      return (
        <div style={{display:'flex',gap:'8px',marginBottom:'24px',overflowX:'auto',padding:'4px 0'}}>
          {getWeekDays().map((d,i)=>{const c=getCount(d),sel=isSameDay(d,selectedDate),tod=isToday(d); return <button key={i} onClick={()=>onSelectDate(d)} style={{flex:'1 0 auto',minWidth:'52px',padding:'12px 8px',background:sel?'var(--accent-primary)':tod?'var(--bg-elevated)':'var(--bg-card)',borderRadius:'var(--radius-md)',color:sel?'white':'var(--text-primary)',cursor:'pointer',textAlign:'center'}}><div style={{fontSize:'11px',opacity:0.7,marginBottom:'4px'}}>{d.toLocaleDateString('en-US',{weekday:'short'}).toUpperCase()}</div><div style={{fontSize:'18px',fontWeight:'600'}}>{d.getDate()}</div>{c>0&&<div style={{width:'6px',height:'6px',borderRadius:'50%',background:sel?'white':'var(--accent-primary)',margin:'4px auto 0'}}/>}</button>;})}
        </div>
      );
    };

    const ProjectView = ({ projects, tasks, onSelectProject, onAddProject }) => {
      const [showAdd, setShowAdd] = useState(false);
      const [newName, setNewName] = useState('');
      const byProject = useMemo(()=>{const g={'Inbox':[]};projects.forEach(p=>g[p.name]=[]);tasks.forEach(t=>{if(!g[t.project])g[t.project]=[];g[t.project].push(t);});return g;},[projects,tasks]);
      return (
        <div>
          <button onClick={()=>setShowAdd(true)} style={{display:'flex',alignItems:'center',gap:'12px',width:'100%',padding:'16px',marginBottom:'16px',background:'var(--bg-card)',border:'2px dashed var(--border-subtle)',borderRadius:'var(--radius-lg)',color:'var(--text-secondary)',cursor:'pointer'}}><Icons.Plus s={20}/>New project</button>
          <div onClick={()=>onSelectProject('Inbox')} style={{display:'flex',alignItems:'center',gap:'16px',padding:'16px',marginBottom:'8px',background:'var(--bg-card)',borderRadius:'var(--radius-lg)',cursor:'pointer'}}><div style={{width:'44px',height:'44px',borderRadius:'12px',background:'#f97316',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'20px'}}>üì•</div><div style={{flex:1}}><div style={{fontWeight:'600'}}>Inbox</div><div style={{fontSize:'13px',color:'var(--text-muted)'}}>{byProject['Inbox']?.filter(t=>!t.completed).length||0} active</div></div><Icons.ChevronRight/></div>
          {projects.map(p=><div key={p.id} onClick={()=>onSelectProject(p.name)} style={{display:'flex',alignItems:'center',gap:'16px',padding:'16px',marginBottom:'8px',background:'var(--bg-card)',borderRadius:'var(--radius-lg)',cursor:'pointer'}}><div style={{width:'44px',height:'44px',borderRadius:'12px',background:p.color,display:'flex',alignItems:'center',justifyContent:'center'}}><Icons.Folder s={22}/></div><div style={{flex:1}}><div style={{fontWeight:'600'}}>{p.name}</div><div style={{fontSize:'13px',color:'var(--text-muted)'}}>{(byProject[p.name]||[]).filter(t=>!t.completed).length} active</div></div><Icons.ChevronRight/></div>)}
          {showAdd && <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.7)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:1000,padding:'20px'}} onClick={()=>setShowAdd(false)}><div style={{background:'var(--bg-card)',borderRadius:'var(--radius-lg)',padding:'24px',width:'100%',maxWidth:'360px'}} onClick={e=>e.stopPropagation()}><h3 style={{marginBottom:'16px'}}>New Project</h3><input autoFocus value={newName} onChange={e=>setNewName(e.target.value)} placeholder="Name..." style={{width:'100%',padding:'14px',background:'var(--bg-elevated)',borderRadius:'var(--radius-md)',color:'var(--text-primary)',fontSize:'16px',marginBottom:'16px'}}/><div style={{display:'flex',gap:'12px'}}><button onClick={()=>setShowAdd(false)} style={{flex:1,padding:'12px',background:'var(--bg-elevated)',borderRadius:'var(--radius-md)',color:'var(--text-secondary)',cursor:'pointer'}}>Cancel</button><button onClick={()=>{if(newName.trim()){onAddProject({id:generateId(),name:newName.trim(),color:'#6366f1'});setNewName('');setShowAdd(false);}}} style={{flex:1,padding:'12px',background:'var(--accent-primary)',borderRadius:'var(--radius-md)',color:'white',cursor:'pointer'}}>Create</button></div></div></div>}
        </div>
      );
    };

    const Settings = ({ onClose, settings, onUpdateSettings, stats, onClearData }) => (
      <div style={{position:'fixed',inset:0,background:'var(--bg-main)',zIndex:100,overflow:'auto',paddingTop:'var(--safe-top)'}}>
        <div style={{padding:'20px',maxWidth:'500px',margin:'0 auto'}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'24px'}}><h2 style={{fontSize:'24px',fontWeight:'700'}}>Settings</h2><button onClick={onClose} style={{background:'none',color:'var(--text-muted)',cursor:'pointer'}}><Icons.X/></button></div>
          <div style={{background:'var(--bg-card)',borderRadius:'var(--radius-lg)',padding:'20px',marginBottom:'20px'}}>
            <h3 style={{marginBottom:'16px'}}>Voice Mode</h3>
            {[{id:'quick',label:'‚ö° Quick',desc:'Fast, no AI'},{id:'smart',label:'‚ú® Smart',desc:'AI splits tasks'},{id:'coach',label:'üß† Coach',desc:'Brain dump mode'}].map(m=>(
              <label key={m.id} style={{display:'flex',alignItems:'center',gap:'12px',padding:'14px',background:settings.voiceMode===m.id?'var(--accent-primary)15':'var(--bg-elevated)',borderRadius:'var(--radius-md)',marginBottom:'8px',cursor:'pointer',border:settings.voiceMode===m.id?'1px solid var(--accent-primary)':'1px solid transparent'}}>
                <input type="radio" checked={settings.voiceMode===m.id} onChange={()=>onUpdateSettings({...settings,voiceMode:m.id})}/>
                <div><div style={{fontWeight:'500'}}>{m.label}</div><div style={{fontSize:'13px',color:'var(--text-muted)'}}>{m.desc}</div></div>
              </label>
            ))}
          </div>
          <div style={{background:'var(--bg-card)',borderRadius:'var(--radius-lg)',padding:'20px',marginBottom:'20px'}}>
            <h3 style={{marginBottom:'16px'}}>Stats</h3>
            <div style={{display:'flex',gap:'12px'}}><div style={{flex:1,background:'var(--bg-elevated)',padding:'16px',borderRadius:'var(--radius-md)',textAlign:'center'}}><div style={{fontSize:'28px',fontWeight:'700',color:'var(--accent-success)'}}>{stats.completed}</div><div style={{fontSize:'12px',color:'var(--text-muted)'}}>Done</div></div><div style={{flex:1,background:'var(--bg-elevated)',padding:'16px',borderRadius:'var(--radius-md)',textAlign:'center'}}><div style={{fontSize:'28px',fontWeight:'700',color:'var(--accent-primary)'}}>{stats.active}</div><div style={{fontSize:'12px',color:'var(--text-muted)'}}>Active</div></div></div>
          </div>
          <button onClick={()=>confirm('Clear all?')&&onClearData()} style={{width:'100%',padding:'14px',background:'var(--accent-danger)15',borderRadius:'var(--radius-md)',color:'var(--accent-danger)',cursor:'pointer'}}>Clear all data</button>
        </div>
      </div>
    );

    // =============================================
    // VOICE BUTTON - THE KEY FIX
    // =============================================
    const VoiceButton = ({ onTasksCreated, voiceMode }) => {
      const [recording, setRecording] = useState(false);
      const [processing, setProcessing] = useState(false);
      const [showText, setShowText] = useState(false);
      const [textVal, setTextVal] = useState('');
      const [duration, setDuration] = useState(0);
      const [statusMsg, setStatusMsg] = useState('');
      const [coachResult, setCoachResult] = useState(null);
      const recRef = useRef(null);
      const timerRef = useRef(null);

      const processInput = async (transcript) => {
        if (!transcript.trim()) return;
        setProcessing(true);
        console.log(`Processing [${voiceMode}]:`, transcript);
        
        try {
          if (voiceMode === 'coach') {
            setStatusMsg('üß† AI Coach analyzing...');
            const result = await GeminiAPI.coachSession(transcript);
            if (result && result.tasks && result.tasks.length > 0) {
              setCoachResult(result);
            } else {
              // Fallback
              const tasks = [{ id: generateId(), name: LocalParser.cleanTaskName(transcript), project: 'Inbox', deadline: setDateAt(0), chunks: LocalParser.generateChunks(transcript), completed: false }];
              onTasksCreated(tasks);
            }
          } else if (voiceMode === 'smart') {
            setStatusMsg('‚ú® Parsing tasks...');
            const parsed = await GeminiAPI.parseVoice(transcript);
            const tasks = [];
            for (const p of parsed) {
              setStatusMsg(`Creating: ${p.name.substring(0, 25)}...`);
              const chunks = await GeminiAPI.generateChunks(p.name);
              tasks.push({ id: generateId(), name: p.name, project: 'Inbox', deadline: deadlineFromText(p.deadline), chunks, completed: false });
            }
            onTasksCreated(tasks);
          } else {
            // Quick mode
            const name = LocalParser.cleanTaskName(transcript);
            onTasksCreated([{ id: generateId(), name, project: 'Inbox', deadline: setDateAt(0), chunks: LocalParser.generateChunks(name), completed: false }]);
          }
        } catch (err) {
          console.error('Process error:', err);
        }
        
        setProcessing(false);
        setStatusMsg('');
      };

      const confirmCoachTasks = () => {
        if (!coachResult) return;
        const tasks = coachResult.tasks.map(t => ({
          id: generateId(),
          name: t.name,
          project: 'Inbox',
          deadline: deadlineFromText(t.deadline),
          chunks: (t.chunks || []).map(c => ({ id: generateId(), name: c, completed: false })),
          completed: false
        }));
        onTasksCreated(tasks);
        setCoachResult(null);
      };

      const startRec = () => {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SR) { setShowText(true); return; }
        recRef.current = new SR();
        recRef.current.continuous = true;
        recRef.current.interimResults = false;
        let transcript = '';
        recRef.current.onresult = e => { for (let i = e.resultIndex; i < e.results.length; i++) if (e.results[i].isFinal) transcript += e.results[i][0].transcript + ' '; };
        recRef.current.onerror = () => { setRecording(false); clearInterval(timerRef.current); setShowText(true); };
        recRef.current.onend = async () => { setRecording(false); clearInterval(timerRef.current); setDuration(0); if (transcript.trim()) await processInput(transcript.trim()); };
        setRecording(true); setDuration(0); recRef.current.start();
        timerRef.current = setInterval(() => setDuration(d => d + 1), 1000);
      };
      
      const stopRec = () => { if (recRef.current) recRef.current.stop(); clearInterval(timerRef.current); };
      
      const handleText = async (e) => { e.preventDefault(); if (!textVal.trim() || processing) return; await processInput(textVal.trim()); setTextVal(''); setShowText(false); };

      if (showText) return (
        <div className="slideUp" style={{position:'fixed',bottom:'100px',left:'20px',right:'20px',background:'var(--bg-card)',borderRadius:'var(--radius-lg)',padding:'20px',border:'1px solid var(--border-subtle)',zIndex:50}}>
          <form onSubmit={handleText}>
            <textarea autoFocus value={textVal} onChange={e=>setTextVal(e.target.value)} placeholder={voiceMode==='coach'?"Brain dump everything...":"What do you need to do?"} rows={3} style={{width:'100%',padding:'14px',background:'var(--bg-elevated)',borderRadius:'var(--radius-md)',color:'var(--text-primary)',fontSize:'16px',resize:'none',marginBottom:'12px'}}/>
            <div style={{display:'flex',gap:'12px'}}>
              <button type="button" onClick={()=>setShowText(false)} style={{flex:1,padding:'12px',background:'var(--bg-elevated)',borderRadius:'var(--radius-md)',color:'var(--text-secondary)',cursor:'pointer'}}>Cancel</button>
              <button type="submit" disabled={!textVal.trim()||processing} style={{flex:2,padding:'12px',background:textVal.trim()&&!processing?'var(--accent-primary)':'var(--bg-elevated)',borderRadius:'var(--radius-md)',color:textVal.trim()&&!processing?'white':'var(--text-muted)',fontWeight:'600',cursor:'pointer'}}>{processing?'Processing...':voiceMode==='coach'?'Analyze':'Add'}</button>
            </div>
          </form>
        </div>
      );

      return (
        <>
          {(processing||statusMsg) && <div style={{position:'fixed',bottom:'180px',left:'20px',right:'20px',zIndex:45}}><div style={{display:'flex',alignItems:'center',gap:'12px',padding:'16px',background:'var(--bg-card)',borderRadius:'var(--radius-md)',border:'1px solid var(--border-subtle)'}}><div style={{display:'flex',gap:'4px'}}>{[0,1,2].map(i=><div key={i} style={{width:'8px',height:'8px',borderRadius:'50%',background:'var(--accent-purple)',animation:`thinking 1s ease-in-out ${i*0.2}s infinite`}}/>)}</div><span style={{fontSize:'14px',color:'var(--text-secondary)'}}>{statusMsg||'Processing...'}</span></div></div>}
          
          <div style={{position:'fixed',bottom:'100px',left:'50%',transform:'translateX(-50%)',display:'flex',alignItems:'center',gap:'12px',zIndex:40}}>
            <button onClick={()=>setShowText(true)} style={{width:'48px',height:'48px',borderRadius:'50%',background:'var(--bg-card)',border:'1px solid var(--border-subtle)',color:'var(--text-secondary)',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center'}}><Icons.Edit/></button>
            <button onClick={recording?stopRec:startRec} disabled={processing} style={{width:'72px',height:'72px',borderRadius:'50%',background:recording?'linear-gradient(135deg,#ef4444,#dc2626)':voiceMode==='coach'?'linear-gradient(135deg,#8b5cf6,#6366f1)':'linear-gradient(135deg,var(--accent-primary),var(--accent-glow))',color:'white',cursor:'pointer',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',boxShadow:recording?'0 0 40px rgba(239,68,68,0.5)':'0 4px 24px rgba(99,102,241,0.4)',animation:recording?'pulse 1s infinite':voiceMode==='coach'?'breathe 3s infinite':'none',opacity:processing?0.5:1}}>
              {processing?<div style={{width:'24px',height:'24px',border:'3px solid white',borderTopColor:'transparent',borderRadius:'50%',animation:'spin 1s linear infinite'}}/>:<>{voiceMode==='coach'&&!recording?<Icons.Brain s={28}/>:<Icons.Mic s={28}/>}{recording&&<span style={{fontSize:'10px',marginTop:'2px'}}>{duration}s</span>}</>}
            </button>
          </div>
          
          <AICoachResult result={coachResult} onConfirm={confirmCoachTasks} onClose={()=>setCoachResult(null)}/>
        </>
      );
    };

    const BottomNav = ({ activeTab, onTabChange, onProfileClick }) => {
      const tabs = [{id:'today',label:'Today',icon:Icons.Zap},{id:'calendar',label:'Calendar',icon:Icons.Calendar},{id:'projects',label:'Projects',icon:Icons.Folder}];
      return (
        <nav style={{position:'fixed',bottom:0,left:0,right:0,background:'var(--bg-card)',borderTop:'1px solid var(--border-subtle)',display:'flex',justifyContent:'space-around',padding:'8px 0',paddingBottom:'calc(8px + var(--safe-bottom))',zIndex:30}}>
          {tabs.map(t=><button key={t.id} onClick={()=>onTabChange(t.id)} style={{display:'flex',flexDirection:'column',alignItems:'center',gap:'4px',padding:'8px 20px',background:'none',color:activeTab===t.id?'var(--accent-primary)':'var(--text-muted)',cursor:'pointer'}}><t.icon s={22}/><span style={{fontSize:'11px'}}>{t.label}</span></button>)}
          <button onClick={onProfileClick} style={{display:'flex',flexDirection:'column',alignItems:'center',gap:'4px',padding:'8px 20px',background:'none',color:'var(--text-muted)',cursor:'pointer'}}><Icons.User s={22}/><span style={{fontSize:'11px'}}>Profile</span></button>
        </nav>
      );
    };

    // =============================================
    // MAIN APP
    // =============================================
    const App = () => {
      const [tasks, setTasks] = useState(()=>{try{return JSON.parse(localStorage.getItem('neurodone_tasks'))||[];}catch{return[];}});
      const [projects, setProjects] = useState(()=>{try{return JSON.parse(localStorage.getItem('neurodone_projects'))||[];}catch{return[];}});
      const [settings, setSettings] = useState(()=>{try{return JSON.parse(localStorage.getItem('neurodone_settings'))||{voiceMode:'smart'};}catch{return{voiceMode:'smart'};}});
      const [activeTab, setActiveTab] = useState('today');
      const [selectedDate, setSelectedDate] = useState(new Date());
      const [selectedProject, setSelectedProject] = useState(null);
      const [showSettings, setShowSettings] = useState(false);
      const [showCelebration, setShowCelebration] = useState(false);
      const [toast, setToast] = useState(null);

      useEffect(()=>{localStorage.setItem('neurodone_tasks',JSON.stringify(tasks));},[tasks]);
      useEffect(()=>{localStorage.setItem('neurodone_projects',JSON.stringify(projects));},[projects]);
      useEffect(()=>{localStorage.setItem('neurodone_settings',JSON.stringify(settings));},[settings]);

      const todayTasks = useMemo(()=>tasks.filter(t=>!t.completed&&(isToday(t.deadline)||getDaysUntil(t.deadline)<0)),[tasks]);
      const calendarTasks = useMemo(()=>tasks.filter(t=>isSameDay(t.deadline,selectedDate)),[tasks,selectedDate]);
      const stats = useMemo(()=>({completed:tasks.filter(t=>t.completed).length,active:tasks.filter(t=>!t.completed).length}),[tasks]);

      const handleTasksCreated = newTasks => { setTasks(prev => [...newTasks, ...prev]); setToast({ message: `${newTasks.length} task${newTasks.length > 1 ? 's' : ''} added! ‚ú®` }); };
      const handleToggleChunk = (taskId, chunkId) => setTasks(tasks.map(t=>t.id===taskId?{...t,chunks:t.chunks.map(c=>c.id===chunkId?{...c,completed:!c.completed}:c)}:t));
      const handleCompleteTask = taskId => { setShowCelebration(true); setTasks(tasks.map(t=>t.id===taskId?{...t,completed:true}:t)); };
      const handleDeleteTask = taskId => setTasks(tasks.filter(t=>t.id!==taskId));
      const handleUpdateDeadline = (taskId, d) => setTasks(tasks.map(t=>t.id===taskId?{...t,deadline:d}:t));
      const handleUpdateChunks = (taskId, newChunks) => setTasks(tasks.map(t=>t.id===taskId?{...t,chunks:newChunks}:t));

      return (
        <div style={{height:'100%',display:'flex',flexDirection:'column',paddingTop:'var(--safe-top)'}}>
          <header style={{padding:'20px',paddingBottom:'12px'}}>
            <p style={{fontSize:'13px',color:'var(--text-muted)',marginBottom:'4px'}}>{new Date().toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'})}</p>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
              <h1 style={{fontSize:'28px',fontWeight:'700'}}>{activeTab==='today'?'Today':activeTab==='calendar'?'Calendar':selectedProject||'Projects'}</h1>
              {activeTab==='today'&&todayTasks.length>0&&<div style={{padding:'6px 12px',background:'var(--bg-card)',borderRadius:'20px',fontSize:'13px'}}>{todayTasks.length} tasks</div>}
              {selectedProject&&<button onClick={()=>setSelectedProject(null)} style={{background:'none',color:'var(--accent-primary)',cursor:'pointer'}}>‚Üê Back</button>}
            </div>
          </header>
          
          <main style={{flex:1,overflow:'auto',padding:'0 20px',paddingBottom:'180px'}}>
            {activeTab==='today'&&(todayTasks.length===0?<div style={{textAlign:'center',padding:'60px 20px'}}><div style={{fontSize:'64px',marginBottom:'16px'}}>üéØ</div><h2 style={{fontSize:'20px',fontWeight:'600',marginBottom:'8px'}}>All clear!</h2><p style={{color:'var(--text-muted)'}}>Tap the mic to add tasks</p></div>:todayTasks.map(t=><TaskCard key={t.id} task={t} onToggleChunk={handleToggleChunk} onComplete={handleCompleteTask} onDelete={handleDeleteTask} onUpdateDeadline={handleUpdateDeadline} onUpdateChunks={handleUpdateChunks}/>))}
            {activeTab==='calendar'&&<><CalendarView tasks={tasks} selectedDate={selectedDate} onSelectDate={setSelectedDate}/><h2 style={{fontSize:'16px',fontWeight:'600',marginBottom:'16px'}}>{formatDateShort(selectedDate)}</h2>{calendarTasks.length===0?<p style={{textAlign:'center',color:'var(--text-muted)',padding:'40px'}}>No tasks</p>:calendarTasks.map(t=><TaskCard key={t.id} task={t} onToggleChunk={handleToggleChunk} onComplete={handleCompleteTask} onDelete={handleDeleteTask} onUpdateDeadline={handleUpdateDeadline} onUpdateChunks={handleUpdateChunks}/>)}</>}
            {activeTab==='projects'&&!selectedProject&&<ProjectView projects={projects} tasks={tasks} onSelectProject={setSelectedProject} onAddProject={p=>setProjects([...projects,p])}/>}
            {activeTab==='projects'&&selectedProject&&(tasks.filter(t=>t.project===selectedProject).length===0?<p style={{textAlign:'center',color:'var(--text-muted)',padding:'40px'}}>No tasks</p>:tasks.filter(t=>t.project===selectedProject).map(t=><TaskCard key={t.id} task={t} onToggleChunk={handleToggleChunk} onComplete={handleCompleteTask} onDelete={handleDeleteTask} onUpdateDeadline={handleUpdateDeadline} onUpdateChunks={handleUpdateChunks}/>))}
          </main>
          
          <VoiceButton onTasksCreated={handleTasksCreated} voiceMode={settings.voiceMode}/>
          <BottomNav activeTab={activeTab} onTabChange={t=>{setActiveTab(t);setSelectedProject(null);}} onProfileClick={()=>setShowSettings(true)}/>
          
          {showSettings&&<Settings onClose={()=>setShowSettings(false)} settings={settings} onUpdateSettings={setSettings} stats={stats} onClearData={()=>{setTasks([]);setProjects([]);}}/>}
          {toast&&<Toast message={toast.message} onClose={()=>setToast(null)}/>}
          <Celebration show={showCelebration} onDone={()=>setShowCelebration(false)}/>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
