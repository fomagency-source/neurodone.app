<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0a0a0f">
  <title>NEURODONE</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/icon-192.svg">
  <link rel="apple-touch-icon" href="/icon-192.svg">
  <style>
    :root {
      --bg-main: #0a0a0f;
      --bg-card: #13131a;
      --bg-elevated: #1a1a24;
      --border-subtle: #2a2a3a;
      --text-primary: #f5f5f7;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --accent-primary: #6366f1;
      --accent-glow: #8b5cf6;
      --accent-success: #22c55e;
      --accent-warning: #f59e0b;
      --accent-danger: #ef4444;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --safe-top: env(safe-area-inset-top, 20px);
      --safe-bottom: env(safe-area-inset-bottom, 20px);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; overflow: hidden; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-main); color: var(--text-primary); }
    #root { height: 100%; }
    input, button, textarea, select { font-family: inherit; }
    @keyframes pulse { 0%, 100% { opacity: 1 } 50% { opacity: 0.5 } }
    @keyframes spin { to { transform: rotate(360deg) } }
    @keyframes slideUp { from { transform: translateY(100%); opacity: 0 } to { transform: translateY(0); opacity: 1 } }
    @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
    @keyframes celebrate { 0% { transform: scale(0) } 50% { transform: scale(1.2) } 100% { transform: scale(1) } }
    @keyframes confetti { 0% { transform: translateY(0) rotate(0deg); opacity: 1 } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0 } }
    @keyframes bounce { 0%, 100% { transform: translateY(0) } 50% { transform: translateY(-5px) } }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ============================================
    // CONFIGURATION
    // ============================================
    const CONFIG = {
      API_ENDPOINT: '/api/parse',
      MAX_FREE_CALLS: 5,
      MAX_PAID_CALLS: 50,
      VOICE_THRESHOLD_SECONDS: 15,
      MIN_CONFIDENCE: 0.7
    };

    // ============================================
    // UTILITIES
    // ============================================
    const generateId = () => Math.random().toString(36).substr(2, 9);
    
    const formatDate = (date) => {
      const d = new Date(date);
      return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    };
    
    const isToday = (date) => {
      const d = new Date(date);
      const today = new Date();
      return d.toDateString() === today.toDateString();
    };
    
    const isTomorrow = (date) => {
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      return new Date(date).toDateString() === tomorrow.toDateString();
    };

    const isPast = (date) => {
      const d = new Date(date);
      const today = new Date();
      today.setHours(0,0,0,0);
      return d < today;
    };
    
    const getRelativeDay = (date) => {
      if (isToday(date)) return 'Today';
      if (isTomorrow(date)) return 'Tomorrow';
      if (isPast(date)) return 'Overdue';
      return formatDate(date);
    };

    const isSameDay = (date1, date2) => {
      const d1 = new Date(date1);
      const d2 = new Date(date2);
      return d1.toDateString() === d2.toDateString();
    };

    // ============================================
    // SMART TASK PARSER (Local + Claude API)
    // ============================================
    class SmartParser {
      constructor() {
        this.learnedPatterns = this.load('neurodone_patterns') || [];
        this.knownProjects = this.load('neurodone_projects') || [];
        this.apiCallsToday = this.getApiCallsToday();
        this.stats = this.load('neurodone_stats') || { local: 0, cloud: 0 };
      }

      load(key) {
        try {
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : null;
        } catch { return null; }
      }

      save(key, data) {
        localStorage.setItem(key, JSON.stringify(data));
      }

      getApiCallsToday() {
        const data = this.load('neurodone_api_calls');
        if (!data || data.date !== new Date().toDateString()) return 0;
        return data.count || 0;
      }

      incrementApiCalls() {
        this.apiCallsToday++;
        this.save('neurodone_api_calls', {
          date: new Date().toDateString(),
          count: this.apiCallsToday
        });
      }

      canUseApi(isPaid = false) {
        const limit = isPaid ? CONFIG.MAX_PAID_CALLS : CONFIG.MAX_FREE_CALLS;
        return this.apiCallsToday < limit;
      }

      // Main parse function
      async parse(input, options = {}) {
        const { voiceDuration = 0, useCoach = false, forceCloud = false, isPaid = false } = options;
        
        console.log('[Parser] Input:', input, 'Duration:', voiceDuration, 'Coach:', useCoach);

        // Decide: local or cloud?
        const shouldUseCloud = forceCloud || 
                              useCoach || 
                              voiceDuration > CONFIG.VOICE_THRESHOLD_SECONDS ||
                              this.isComplex(input);

        if (shouldUseCloud && this.canUseApi(isPaid)) {
          console.log('[Parser] Using Claude API');
          try {
            const result = await this.parseWithClaude(input, useCoach);
            this.learnFrom(input, result);
            this.stats.cloud++;
            this.save('neurodone_stats', this.stats);
            return result;
          } catch (error) {
            console.error('[Parser] API failed, falling back to local:', error);
          }
        }

        console.log('[Parser] Using local parser');
        this.stats.local++;
        this.save('neurodone_stats', this.stats);
        return this.parseLocally(input);
      }

      isComplex(input) {
        const text = input.toLowerCase();
        // Multiple tasks?
        if ((text.match(/\band\b/g) || []).length >= 2) return true;
        if (text.includes('first') && text.includes('then')) return true;
        // Very long?
        if (input.split(' ').length > 20) return true;
        // Ambiguous?
        if (text.includes('?') || text.includes('maybe')) return true;
        return false;
      }

      // Claude API call
      async parseWithClaude(input, isCoach = false) {
        const response = await fetch(CONFIG.API_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            input,
            mode: isCoach ? 'coach' : 'parse',
            userProjects: this.knownProjects,
            context: {
              timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
              currentDate: new Date().toISOString()
            }
          })
        });

        if (!response.ok) throw new Error('API error');
        
        this.incrementApiCalls();
        const data = await response.json();
        
        // Handle coach mode (multiple tasks)
        if (isCoach && data.tasks) {
          return data.tasks.map(t => this.formatTask(t));
        }
        
        return this.formatTask(data);
      }

      // Local parsing (rule-based)
      parseLocally(input) {
        const text = input.trim();
        
        // Clean up common voice artifacts
        let cleanText = text
          .replace(/^(hey|hi|hello|ok|okay)\s*(claude|clot|cloud|ai)?\s*/i, '')
          .replace(/^(please|can you|could you|i need to|i want to|i have to)\s*/i, '')
          .replace(/^(create|add|make)\s*(a\s*)?(task|to-?do|item)?\s*(for|about|to)?\s*/i, '')
          .replace(/\s+/g, ' ')
          .trim();

        // Extract project
        let project = 'Inbox';
        const projectMatch = cleanText.match(/\b(?:for|project|client)\s+([A-Z][a-zA-Z0-9\s]{1,20}?)(?:\s+by|\s+until|\s+before|\s+tomorrow|\s+today|$)/i);
        if (projectMatch) {
          project = projectMatch[1].trim();
          cleanText = cleanText.replace(projectMatch[0], '').trim();
        }

        // Check known projects
        for (const known of this.knownProjects) {
          if (cleanText.toLowerCase().includes(known.toLowerCase())) {
            project = known;
            break;
          }
        }

        // Extract deadline
        const deadline = this.extractDeadline(cleanText);
        
        // Clean task name
        let taskName = cleanText
          .replace(/\b(by|until|before|on|due)\s+(today|tomorrow|monday|tuesday|wednesday|thursday|friday|saturday|sunday|next week|\d{1,2}\/\d{1,2})/gi, '')
          .replace(/\b(today|tomorrow|next week)\b/gi, '')
          .replace(/\s+/g, ' ')
          .trim();

        // Capitalize properly
        if (taskName.length > 0) {
          taskName = taskName.charAt(0).toUpperCase() + taskName.slice(1);
        } else {
          taskName = text.charAt(0).toUpperCase() + text.slice(1);
        }

        // Generate ADHD-friendly chunks
        const chunks = this.generateChunks(taskName);

        // Learn this project
        if (project !== 'Inbox' && !this.knownProjects.includes(project)) {
          this.knownProjects.push(project);
          this.save('neurodone_projects', this.knownProjects);
        }

        return this.formatTask({ name: taskName, project, deadline, chunks });
      }

      extractDeadline(text) {
        const now = new Date();
        const lowerText = text.toLowerCase();

        // Today
        if (lowerText.includes('today') || lowerText.includes('now')) {
          now.setHours(18, 0, 0, 0);
          return now.toISOString();
        }

        // Tomorrow
        if (lowerText.includes('tomorrow')) {
          now.setDate(now.getDate() + 1);
          now.setHours(18, 0, 0, 0);
          return now.toISOString();
        }

        // Day of week
        const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        for (let i = 0; i < days.length; i++) {
          if (lowerText.includes(days[i])) {
            const currentDay = now.getDay();
            let daysUntil = i - currentDay;
            if (daysUntil <= 0) daysUntil += 7;
            now.setDate(now.getDate() + daysUntil);
            now.setHours(18, 0, 0, 0);
            return now.toISOString();
          }
        }

        // Next week
        if (lowerText.includes('next week')) {
          now.setDate(now.getDate() + 7);
          now.setHours(18, 0, 0, 0);
          return now.toISOString();
        }

        // Default: TODAY (important for UX!)
        now.setHours(23, 59, 0, 0);
        return now.toISOString();
      }

      generateChunks(taskName) {
        const name = taskName.toLowerCase();
        let templates = ['Start task', 'Main work', 'Finish up'];

        const chunkMap = [
          { keywords: ['presentation', 'deck', 'slides', 'pitch'], chunks: ['Research & gather', 'Create outline', 'Design slides', 'Review'] },
          { keywords: ['report', 'document', 'write', 'article'], chunks: ['Outline', 'First draft', 'Edit', 'Final review'] },
          { keywords: ['email', 'message', 'reply'], chunks: ['Draft', 'Review tone', 'Send'] },
          { keywords: ['meeting', 'call'], chunks: ['Prepare agenda', 'Join meeting', 'Follow up'] },
          { keywords: ['design', 'create', 'build'], chunks: ['Research', 'Sketch ideas', 'Create', 'Refine'] },
          { keywords: ['review', 'check', 'audit'], chunks: ['Gather info', 'Review', 'Note findings'] },
          { keywords: ['plan', 'strategy'], chunks: ['Research', 'Draft plan', 'Review'] },
          { keywords: ['fix', 'debug', 'solve'], chunks: ['Identify issue', 'Fix', 'Test'] },
          { keywords: ['learn', 'study', 'read'], chunks: ['Set up', 'Study session', 'Review notes'] },
          { keywords: ['buy', 'order', 'shop'], chunks: ['Research options', 'Compare', 'Purchase'] },
        ];

        for (const map of chunkMap) {
          if (map.keywords.some(k => name.includes(k))) {
            templates = map.chunks;
            break;
          }
        }

        return templates.map((name, i) => ({
          id: generateId(),
          name,
          completed: false,
          order: i
        }));
      }

      formatTask(data) {
        return {
          id: generateId(),
          name: data.name || 'Untitled Task',
          project: data.project || 'Inbox',
          deadline: data.deadline || new Date().toISOString(),
          chunks: data.chunks || this.generateChunks(data.name || ''),
          completed: false,
          createdAt: new Date().toISOString()
        };
      }

      learnFrom(input, result) {
        // Store pattern for future local parsing
        const pattern = {
          input: input.toLowerCase().substring(0, 100),
          project: result.project,
          chunkCount: result.chunks?.length || 3,
          timestamp: Date.now()
        };
        this.learnedPatterns.push(pattern);
        if (this.learnedPatterns.length > 50) {
          this.learnedPatterns = this.learnedPatterns.slice(-50);
        }
        this.save('neurodone_patterns', this.learnedPatterns);
      }

      getStats() {
        return {
          local: this.stats.local || 0,
          cloud: this.stats.cloud || 0,
          localPercent: this.stats.local + this.stats.cloud > 0 
            ? Math.round(this.stats.local / (this.stats.local + this.stats.cloud) * 100) 
            : 0,
          apiCallsToday: this.apiCallsToday,
          learnedPatterns: this.learnedPatterns.length,
          knownProjects: this.knownProjects.length
        };
      }
    }

    // Global parser instance
    const parser = new SmartParser();

    // ============================================
    // ICONS
    // ============================================
    const Icons = {
      Mic: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>,
      Plus: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
      Check: () => <svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round"><polyline points="4 10 8 14 16 6"/></svg>,
      Calendar: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
      Folder: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>,
      User: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
      X: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
      Settings: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
      Crown: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M2 17l3-12 5 6 4-8 4 8 5-6 3 12z"/></svg>,
      ChevronLeft: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><polyline points="15 18 9 12 15 6"/></svg>,
      ChevronRight: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><polyline points="9 18 15 12 9 6"/></svg>,
      ChevronDown: () => <svg width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><polyline points="6 9 12 15 18 9"/></svg>,
      Edit: () => <svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
      MessageCircle: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>,
      Zap: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
      Brain: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 4.44-1.04z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24A2.5 2.5 0 0 0 14.5 2z"/></svg>,
    };

    // ============================================
    // CELEBRATION COMPONENT
    // ============================================
    const Celebration = ({ show, onDone }) => {
      useEffect(() => {
        if (show) {
          const timer = setTimeout(onDone, 2000);
          return () => clearTimeout(timer);
        }
      }, [show, onDone]);

      if (!show) return null;

      const colors = ['#6366f1', '#8b5cf6', '#22c55e', '#f59e0b', '#ef4444', '#ec4899'];
      const confetti = Array.from({ length: 40 }, (_, i) => ({
        left: Math.random() * 100,
        delay: Math.random() * 0.5,
        color: colors[Math.floor(Math.random() * colors.length)],
        size: 6 + Math.random() * 8
      }));

      return (
        <div style={{ position: 'fixed', inset: 0, zIndex: 1000, pointerEvents: 'none' }}>
          {confetti.map((c, i) => (
            <div key={i} style={{
              position: 'absolute',
              left: `${c.left}%`,
              top: -20,
              width: c.size,
              height: c.size,
              background: c.color,
              borderRadius: '2px',
              animation: `confetti 2s ease-out ${c.delay}s forwards`
            }} />
          ))}
          <div style={{
            position: 'absolute',
            top: '40%',
            left: '50%',
            transform: 'translate(-50%, -50%)',
            animation: 'celebrate 0.5s ease-out',
            textAlign: 'center'
          }}>
            <div style={{ fontSize: '64px' }}>üéâ</div>
            <div style={{ fontSize: '24px', fontWeight: '700', color: 'var(--accent-success)' }}>Done!</div>
          </div>
        </div>
      );
    };

    // ============================================
    // TASK CARD COMPONENT
    // ============================================
    const TaskCard = ({ task, onToggleChunk, onComplete }) => {
      const [expanded, setExpanded] = useState(false);
      const completedChunks = task.chunks.filter(c => c.completed).length;
      const progress = (completedChunks / task.chunks.length) * 100;
      const allDone = completedChunks === task.chunks.length;

      return (
        <div style={{
          background: 'var(--bg-card)',
          borderRadius: 'var(--radius-lg)',
          padding: '16px',
          marginBottom: '12px',
          border: `1px solid ${allDone ? 'var(--accent-success)' : 'var(--border-subtle)'}`,
          opacity: task.completed ? 0.5 : 1,
          transition: 'all 0.2s'
        }}>
          {/* Header */}
          <div style={{ marginBottom: '12px' }}>
            <div style={{ 
              fontSize: '12px', 
              fontWeight: '600', 
              color: 'var(--accent-primary)', 
              textTransform: 'uppercase',
              marginBottom: '4px'
            }}>
              {task.project}
            </div>
            <h3 style={{ 
              fontSize: '16px', 
              fontWeight: '600', 
              marginBottom: '6px',
              textDecoration: task.completed ? 'line-through' : 'none',
              color: task.completed ? 'var(--text-muted)' : 'var(--text-primary)'
            }}>
              {task.name}
            </h3>
            <div style={{ display: 'flex', gap: '12px', fontSize: '13px', color: 'var(--text-muted)' }}>
              <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                <Icons.Calendar /> {getRelativeDay(task.deadline)}
              </span>
              <span>‚è± {task.chunks.length * 10}m est.</span>
            </div>
          </div>

          {/* Progress bar */}
          <div style={{
            height: '6px',
            background: 'var(--bg-elevated)',
            borderRadius: '3px',
            overflow: 'hidden',
            marginBottom: '12px'
          }}>
            <div style={{
              height: '100%',
              width: `${progress}%`,
              background: allDone ? 'var(--accent-success)' : 'linear-gradient(90deg, var(--accent-primary), var(--accent-glow))',
              transition: 'width 0.3s ease'
            }} />
          </div>

          {/* Chunks toggle & complete button */}
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <button
              onClick={() => setExpanded(!expanded)}
              style={{
                background: 'none',
                border: 'none',
                color: 'var(--text-secondary)',
                fontSize: '13px',
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                gap: '4px'
              }}
            >
              {completedChunks}/{task.chunks.length} steps 
              <span style={{ transform: expanded ? 'rotate(180deg)' : 'rotate(0)', transition: 'transform 0.2s' }}>
                <Icons.ChevronDown />
              </span>
            </button>
            
            {allDone && !task.completed && (
              <button
                onClick={() => onComplete(task.id)}
                style={{
                  background: 'linear-gradient(135deg, var(--accent-success), #16a34a)',
                  border: 'none',
                  borderRadius: 'var(--radius-sm)',
                  padding: '8px 16px',
                  color: 'white',
                  fontWeight: '600',
                  fontSize: '14px',
                  cursor: 'pointer',
                  animation: 'bounce 1s infinite'
                }}
              >
                Complete! üéâ
              </button>
            )}
          </div>

          {/* Expanded chunks */}
          {expanded && (
            <div style={{ marginTop: '12px', paddingTop: '12px', borderTop: '1px solid var(--border-subtle)' }}>
              {task.chunks.map((chunk, i) => (
                <div
                  key={chunk.id}
                  onClick={() => !task.completed && onToggleChunk(task.id, chunk.id)}
                  style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px',
                    padding: '10px 0',
                    borderBottom: i < task.chunks.length - 1 ? '1px solid var(--border-subtle)' : 'none',
                    cursor: task.completed ? 'default' : 'pointer'
                  }}
                >
                  <div style={{
                    width: '24px',
                    height: '24px',
                    borderRadius: '6px',
                    border: chunk.completed ? 'none' : '2px solid var(--border-subtle)',
                    background: chunk.completed ? 'var(--accent-success)' : 'transparent',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    flexShrink: 0,
                    transition: 'all 0.2s'
                  }}>
                    {chunk.completed && <Icons.Check />}
                  </div>
                  <span style={{
                    fontSize: '14px',
                    color: chunk.completed ? 'var(--text-muted)' : 'var(--text-primary)',
                    textDecoration: chunk.completed ? 'line-through' : 'none'
                  }}>
                    {chunk.name}
                  </span>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    };

    // ============================================
    // CALENDAR COMPONENT
    // ============================================
    const Calendar = ({ tasks, selectedDate, onSelectDate }) => {
      const [viewDate, setViewDate] = useState(new Date());
      
      const monthStart = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1);
      const startDay = monthStart.getDay();
      const daysInMonth = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate();
      
      const days = [];
      for (let i = 0; i < startDay; i++) days.push(null);
      for (let i = 1; i <= daysInMonth; i++) days.push(i);

      const getTaskCountForDay = (day) => {
        if (!day) return 0;
        const date = new Date(viewDate.getFullYear(), viewDate.getMonth(), day);
        return tasks.filter(t => !t.completed && isSameDay(t.deadline, date)).length;
      };

      const isSelected = (day) => {
        if (!day) return false;
        const date = new Date(viewDate.getFullYear(), viewDate.getMonth(), day);
        return isSameDay(date, selectedDate);
      };

      const isTodayCell = (day) => {
        if (!day) return false;
        const date = new Date(viewDate.getFullYear(), viewDate.getMonth(), day);
        return isToday(date);
      };

      return (
        <div style={{ marginBottom: '24px' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
            <button 
              onClick={() => setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() - 1))}
              style={{ background: 'none', border: 'none', color: 'var(--text-secondary)', cursor: 'pointer', padding: '8px' }}
            >
              <Icons.ChevronLeft />
            </button>
            <h3 style={{ fontSize: '16px', fontWeight: '600' }}>
              {viewDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
            </h3>
            <button 
              onClick={() => setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() + 1))}
              style={{ background: 'none', border: 'none', color: 'var(--text-secondary)', cursor: 'pointer', padding: '8px' }}
            >
              <Icons.ChevronRight />
            </button>
          </div>
          
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '4px' }}>
            {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((d, i) => (
              <div key={i} style={{ textAlign: 'center', fontSize: '12px', color: 'var(--text-muted)', padding: '8px' }}>{d}</div>
            ))}
            {days.map((day, i) => {
              const taskCount = getTaskCountForDay(day);
              return (
                <button
                  key={i}
                  onClick={() => day && onSelectDate(new Date(viewDate.getFullYear(), viewDate.getMonth(), day))}
                  disabled={!day}
                  style={{
                    background: isSelected(day) ? 'var(--accent-primary)' : isTodayCell(day) ? 'var(--bg-elevated)' : 'transparent',
                    border: 'none',
                    borderRadius: '8px',
                    padding: '8px 4px',
                    color: day ? (isSelected(day) ? 'white' : 'var(--text-primary)') : 'transparent',
                    cursor: day ? 'pointer' : 'default',
                    position: 'relative',
                    fontSize: '14px'
                  }}
                >
                  {day}
                  {taskCount > 0 && !isSelected(day) && (
                    <div style={{
                      position: 'absolute',
                      bottom: '2px',
                      left: '50%',
                      transform: 'translateX(-50%)',
                      width: taskCount > 1 ? '12px' : '4px',
                      height: '4px',
                      borderRadius: '2px',
                      background: 'var(--accent-primary)',
                      fontSize: '8px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center'
                    }}>
                      {taskCount > 1 && <span style={{ color: 'white', fontSize: '8px' }}>{taskCount}</span>}
                    </div>
                  )}
                </button>
              );
            })}
          </div>
        </div>
      );
    };

    // ============================================
    // VOICE INPUT COMPONENT (with mode selection)
    // ============================================
    const VoiceInput = ({ onAddTask, onAddTasks, voiceMode, isPaid }) => {
      const [isRecording, setIsRecording] = useState(false);
      const [processing, setProcessing] = useState(false);
      const [showTextInput, setShowTextInput] = useState(false);
      const [textValue, setTextValue] = useState('');
      const [recordingTime, setRecordingTime] = useState(0);
      const [showModeSelect, setShowModeSelect] = useState(false);
      
      const recognitionRef = useRef(null);
      const timerRef = useRef(null);

      const startRecording = (useCoach = false) => {
        setShowModeSelect(false);
        
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
          alert('Voice not supported in this browser. Please use Chrome or Safari.');
          setShowTextInput(true);
          return;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognitionRef.current = new SpeechRecognition();
        recognitionRef.current.continuous = true;
        recognitionRef.current.interimResults = false;

        let fullTranscript = '';
        
        recognitionRef.current.onresult = (event) => {
          for (let i = event.resultIndex; i < event.results.length; i++) {
            if (event.results[i].isFinal) {
              fullTranscript += ' ' + event.results[i][0].transcript;
            }
          }
        };

        recognitionRef.current.onerror = (e) => {
          console.error('Speech error:', e);
          stopRecording(fullTranscript, useCoach);
        };

        recognitionRef.current.onend = () => {
          stopRecording(fullTranscript, useCoach);
        };

        setIsRecording(true);
        setRecordingTime(0);
        recognitionRef.current.start();

        // Timer
        timerRef.current = setInterval(() => {
          setRecordingTime(t => t + 1);
        }, 1000);
      };

      const stopRecording = async (transcript, useCoach = false) => {
        if (timerRef.current) clearInterval(timerRef.current);
        if (recognitionRef.current) recognitionRef.current.stop();
        setIsRecording(false);

        const text = (transcript || '').trim();
        if (!text) return;

        setProcessing(true);
        try {
          if (useCoach) {
            // Coach mode might return multiple tasks
            const result = await parser.parse(text, { 
              voiceDuration: recordingTime, 
              useCoach: true,
              isPaid 
            });
            
            if (Array.isArray(result)) {
              onAddTasks(result);
            } else {
              onAddTask(result);
            }
          } else {
            const task = await parser.parse(text, { 
              voiceDuration: recordingTime,
              isPaid 
            });
            onAddTask(task);
          }
        } catch (error) {
          console.error('Parse error:', error);
        }
        setProcessing(false);
        setRecordingTime(0);
      };

      const handleTextSubmit = async (e) => {
        e.preventDefault();
        if (!textValue.trim()) return;
        
        setProcessing(true);
        try {
          const task = await parser.parse(textValue, { isPaid });
          onAddTask(task);
          setTextValue('');
          setShowTextInput(false);
        } catch (error) {
          console.error('Parse error:', error);
        }
        setProcessing(false);
      };

      // Text input modal
      if (showTextInput) {
        return (
          <div style={{
            position: 'fixed',
            bottom: '100px',
            left: '20px',
            right: '20px',
            background: 'var(--bg-card)',
            borderRadius: 'var(--radius-lg)',
            padding: '20px',
            border: '1px solid var(--border-subtle)',
            animation: 'slideUp 0.3s ease',
            zIndex: 50
          }}>
            <form onSubmit={handleTextSubmit}>
              <input
                autoFocus
                value={textValue}
                onChange={(e) => setTextValue(e.target.value)}
                placeholder="e.g. Finish report for Acme by Friday"
                style={{
                  width: '100%',
                  padding: '14px',
                  fontSize: '16px',
                  background: 'var(--bg-elevated)',
                  border: '1px solid var(--border-subtle)',
                  borderRadius: 'var(--radius-md)',
                  color: 'var(--text-primary)',
                  marginBottom: '12px',
                  outline: 'none'
                }}
              />
              <div style={{ display: 'flex', gap: '12px' }}>
                <button
                  type="button"
                  onClick={() => setShowTextInput(false)}
                  style={{
                    flex: 1,
                    padding: '12px',
                    background: 'var(--bg-elevated)',
                    border: 'none',
                    borderRadius: 'var(--radius-md)',
                    color: 'var(--text-secondary)',
                    cursor: 'pointer'
                  }}
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  disabled={!textValue.trim() || processing}
                  style={{
                    flex: 2,
                    padding: '12px',
                    background: textValue.trim() ? 'linear-gradient(135deg, var(--accent-primary), var(--accent-glow))' : 'var(--bg-elevated)',
                    border: 'none',
                    borderRadius: 'var(--radius-md)',
                    color: textValue.trim() ? 'white' : 'var(--text-muted)',
                    fontWeight: '600',
                    cursor: textValue.trim() ? 'pointer' : 'not-allowed'
                  }}
                >
                  {processing ? 'Adding...' : 'Add Task'}
                </button>
              </div>
            </form>
          </div>
        );
      }

      // Mode selection (coach vs quick)
      if (showModeSelect) {
        return (
          <div style={{
            position: 'fixed',
            bottom: '100px',
            left: '20px',
            right: '20px',
            background: 'var(--bg-card)',
            borderRadius: 'var(--radius-lg)',
            padding: '20px',
            border: '1px solid var(--border-subtle)',
            animation: 'slideUp 0.3s ease',
            zIndex: 50
          }}>
            <h3 style={{ marginBottom: '16px', textAlign: 'center' }}>How do you want to add tasks?</h3>
            
            <button
              onClick={() => startRecording(false)}
              style={{
                width: '100%',
                padding: '16px',
                background: 'var(--bg-elevated)',
                border: '1px solid var(--border-subtle)',
                borderRadius: 'var(--radius-md)',
                color: 'var(--text-primary)',
                marginBottom: '12px',
                cursor: 'pointer',
                textAlign: 'left',
                display: 'flex',
                alignItems: 'center',
                gap: '12px'
              }}
            >
              <div style={{ fontSize: '24px' }}>‚ö°</div>
              <div>
                <div style={{ fontWeight: '600' }}>Quick Add</div>
                <div style={{ fontSize: '13px', color: 'var(--text-muted)' }}>Say one task, add it instantly</div>
              </div>
            </button>
            
            <button
              onClick={() => startRecording(true)}
              style={{
                width: '100%',
                padding: '16px',
                background: 'linear-gradient(135deg, var(--accent-primary)20, var(--accent-glow)20)',
                border: '1px solid var(--accent-primary)',
                borderRadius: 'var(--radius-md)',
                color: 'var(--text-primary)',
                marginBottom: '12px',
                cursor: 'pointer',
                textAlign: 'left',
                display: 'flex',
                alignItems: 'center',
                gap: '12px'
              }}
            >
              <div style={{ fontSize: '24px' }}>üß†</div>
              <div>
                <div style={{ fontWeight: '600' }}>AI Brain Dump</div>
                <div style={{ fontSize: '13px', color: 'var(--text-muted)' }}>Speak freely, AI organizes everything</div>
              </div>
            </button>
            
            <button
              onClick={() => setShowModeSelect(false)}
              style={{
                width: '100%',
                padding: '12px',
                background: 'transparent',
                border: 'none',
                color: 'var(--text-muted)',
                cursor: 'pointer'
              }}
            >
              Cancel
            </button>
          </div>
        );
      }

      return (
        <div style={{
          position: 'fixed',
          bottom: '100px',
          left: '50%',
          transform: 'translateX(-50%)',
          display: 'flex',
          alignItems: 'center',
          gap: '12px',
          zIndex: 40
        }}>
          {/* Text button */}
          <button
            onClick={() => setShowTextInput(true)}
            disabled={isRecording || processing}
            style={{
              width: '48px',
              height: '48px',
              borderRadius: '50%',
              background: 'var(--bg-card)',
              border: '1px solid var(--border-subtle)',
              color: 'var(--text-secondary)',
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center'
            }}
          >
            <Icons.Edit />
          </button>

          {/* Main voice button */}
          <button
            onClick={() => {
              if (isRecording) {
                if (recognitionRef.current) recognitionRef.current.stop();
              } else if (voiceMode === 'select') {
                setShowModeSelect(true);
              } else if (voiceMode === 'coach') {
                startRecording(true);
              } else {
                startRecording(false);
              }
            }}
            disabled={processing}
            style={{
              width: '72px',
              height: '72px',
              borderRadius: '50%',
              background: isRecording 
                ? 'linear-gradient(135deg, var(--accent-danger), #dc2626)' 
                : 'linear-gradient(135deg, var(--accent-primary), var(--accent-glow))',
              border: 'none',
              color: 'white',
              cursor: 'pointer',
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              justifyContent: 'center',
              boxShadow: isRecording ? '0 0 30px rgba(239, 68, 68, 0.5)' : '0 4px 20px rgba(99, 102, 241, 0.4)',
              animation: isRecording ? 'pulse 1s infinite' : 'none'
            }}
          >
            {processing ? (
              <div style={{ width: '24px', height: '24px', border: '3px solid white', borderTopColor: 'transparent', borderRadius: '50%', animation: 'spin 1s linear infinite' }} />
            ) : (
              <>
                <Icons.Mic />
                {isRecording && <span style={{ fontSize: '10px', marginTop: '2px' }}>{recordingTime}s</span>}
              </>
            )}
          </button>
        </div>
      );
    };

    // ============================================
    // BOTTOM NAVIGATION
    // ============================================
    const BottomNav = ({ activeTab, onTabChange, onProfile }) => {
      const tabs = [
        { id: 'today', label: 'Today', icon: Icons.Zap },
        { id: 'calendar', label: 'Calendar', icon: Icons.Calendar },
        { id: 'projects', label: 'Projects', icon: Icons.Folder },
      ];

      return (
        <nav style={{
          position: 'fixed',
          bottom: 0,
          left: 0,
          right: 0,
          background: 'var(--bg-card)',
          borderTop: '1px solid var(--border-subtle)',
          padding: '8px 0',
          paddingBottom: 'calc(8px + var(--safe-bottom))',
          display: 'flex',
          justifyContent: 'space-around',
          zIndex: 30
        }}>
          {tabs.map(tab => (
            <button
              key={tab.id}
              onClick={() => onTabChange(tab.id)}
              style={{
                background: 'none',
                border: 'none',
                color: activeTab === tab.id ? 'var(--accent-primary)' : 'var(--text-muted)',
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                gap: '4px',
                padding: '8px 20px',
                cursor: 'pointer',
                transition: 'color 0.2s'
              }}
            >
              <tab.icon />
              <span style={{ fontSize: '11px', fontWeight: activeTab === tab.id ? '600' : '400' }}>{tab.label}</span>
            </button>
          ))}
          <button
            onClick={onProfile}
            style={{
              background: 'none',
              border: 'none',
              color: 'var(--text-muted)',
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              gap: '4px',
              padding: '8px 20px',
              cursor: 'pointer'
            }}
          >
            <Icons.User />
            <span style={{ fontSize: '11px' }}>Profile</span>
          </button>
        </nav>
      );
    };

    // ============================================
    // SETTINGS PAGE
    // ============================================
    const SettingsPage = ({ settings, onUpdate, onClose, stats }) => {
      return (
        <div style={{
          position: 'fixed',
          inset: 0,
          background: 'var(--bg-main)',
          zIndex: 100,
          overflow: 'auto',
          paddingTop: 'var(--safe-top)'
        }}>
          <div style={{ padding: '20px', maxWidth: '500px', margin: '0 auto' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '32px' }}>
              <h2 style={{ fontSize: '24px', fontWeight: '700' }}>Settings</h2>
              <button onClick={onClose} style={{ background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer' }}>
                <Icons.X />
              </button>
            </div>

            {/* Voice Mode Setting */}
            <div style={{ background: 'var(--bg-card)', borderRadius: 'var(--radius-lg)', padding: '20px', marginBottom: '16px' }}>
              <h3 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                <Icons.Mic /> Voice Mode
              </h3>
              
              {[
                { id: 'quick', label: 'Quick Add', desc: 'Tap mic ‚Üí speak ‚Üí task added' },
                { id: 'coach', label: 'AI Coach', desc: 'Brain dump mode, AI structures everything' },
                { id: 'select', label: 'Ask Every Time', desc: 'Choose mode when tapping mic' }
              ].map(mode => (
                <label 
                  key={mode.id}
                  style={{
                    display: 'flex',
                    alignItems: 'flex-start',
                    gap: '12px',
                    padding: '12px',
                    background: settings.voiceMode === mode.id ? 'var(--accent-primary)15' : 'transparent',
                    borderRadius: 'var(--radius-md)',
                    marginBottom: '8px',
                    cursor: 'pointer',
                    border: settings.voiceMode === mode.id ? '1px solid var(--accent-primary)' : '1px solid transparent'
                  }}
                >
                  <input
                    type="radio"
                    name="voiceMode"
                    checked={settings.voiceMode === mode.id}
                    onChange={() => onUpdate({ ...settings, voiceMode: mode.id })}
                    style={{ marginTop: '4px' }}
                  />
                  <div>
                    <div style={{ fontWeight: '500' }}>{mode.label}</div>
                    <div style={{ fontSize: '13px', color: 'var(--text-muted)' }}>{mode.desc}</div>
                  </div>
                </label>
              ))}
            </div>

            {/* AI Stats */}
            <div style={{ background: 'var(--bg-card)', borderRadius: 'var(--radius-lg)', padding: '20px', marginBottom: '16px' }}>
              <h3 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                <Icons.Brain /> AI Usage Stats
              </h3>
              
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                <div style={{ background: 'var(--bg-elevated)', padding: '16px', borderRadius: 'var(--radius-md)', textAlign: 'center' }}>
                  <div style={{ fontSize: '24px', fontWeight: '700', color: 'var(--accent-success)' }}>{stats.localPercent}%</div>
                  <div style={{ fontSize: '12px', color: 'var(--text-muted)' }}>Local parsing</div>
                </div>
                <div style={{ background: 'var(--bg-elevated)', padding: '16px', borderRadius: 'var(--radius-md)', textAlign: 'center' }}>
                  <div style={{ fontSize: '24px', fontWeight: '700', color: 'var(--accent-primary)' }}>{stats.cloud}</div>
                  <div style={{ fontSize: '12px', color: 'var(--text-muted)' }}>API calls total</div>
                </div>
                <div style={{ background: 'var(--bg-elevated)', padding: '16px', borderRadius: 'var(--radius-md)', textAlign: 'center' }}>
                  <div style={{ fontSize: '24px', fontWeight: '700' }}>{stats.apiCallsToday}</div>
                  <div style={{ fontSize: '12px', color: 'var(--text-muted)' }}>API calls today</div>
                </div>
                <div style={{ background: 'var(--bg-elevated)', padding: '16px', borderRadius: 'var(--radius-md)', textAlign: 'center' }}>
                  <div style={{ fontSize: '24px', fontWeight: '700' }}>{stats.learnedPatterns}</div>
                  <div style={{ fontSize: '12px', color: 'var(--text-muted)' }}>Learned patterns</div>
                </div>
              </div>
              
              <p style={{ fontSize: '13px', color: 'var(--text-muted)', marginTop: '16px' }}>
                The more you use NEURODONE, the smarter local parsing becomes. 
                This saves API costs and makes the app faster!
              </p>
            </div>

            {/* Data Management */}
            <div style={{ background: 'var(--bg-card)', borderRadius: 'var(--radius-lg)', padding: '20px' }}>
              <h3 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '16px' }}>Data</h3>
              
              <button
                onClick={() => {
                  if (confirm('Clear all tasks? This cannot be undone.')) {
                    localStorage.removeItem('neurodone_tasks');
                    window.location.reload();
                  }
                }}
                style={{
                  width: '100%',
                  padding: '12px',
                  background: 'var(--bg-elevated)',
                  border: '1px solid var(--accent-danger)30',
                  borderRadius: 'var(--radius-md)',
                  color: 'var(--accent-danger)',
                  cursor: 'pointer',
                  marginBottom: '8px'
                }}
              >
                Clear All Tasks
              </button>
              
              <button
                onClick={() => {
                  if (confirm('Reset learned patterns? AI will need to re-learn your preferences.')) {
                    localStorage.removeItem('neurodone_patterns');
                    localStorage.removeItem('neurodone_projects');
                    localStorage.removeItem('neurodone_stats');
                    window.location.reload();
                  }
                }}
                style={{
                  width: '100%',
                  padding: '12px',
                  background: 'var(--bg-elevated)',
                  border: '1px solid var(--border-subtle)',
                  borderRadius: 'var(--radius-md)',
                  color: 'var(--text-secondary)',
                  cursor: 'pointer'
                }}
              >
                Reset AI Learning
              </button>
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // PROFILE PAGE
    // ============================================
    const ProfilePage = ({ user, onClose, onUpgrade, onSettings }) => {
      return (
        <div style={{
          position: 'fixed',
          inset: 0,
          background: 'var(--bg-main)',
          zIndex: 100,
          overflow: 'auto',
          paddingTop: 'var(--safe-top)'
        }}>
          <div style={{ padding: '20px' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '32px' }}>
              <h2 style={{ fontSize: '24px', fontWeight: '700' }}>Profile</h2>
              <button onClick={onClose} style={{ background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer' }}>
                <Icons.X />
              </button>
            </div>

            {/* User card */}
            <div style={{ display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '24px' }}>
              <div style={{
                width: '64px',
                height: '64px',
                borderRadius: '50%',
                background: 'linear-gradient(135deg, var(--accent-primary), var(--accent-glow))',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center'
              }}>
                <Icons.User />
              </div>
              <div>
                <div style={{ fontSize: '18px', fontWeight: '600' }}>ADHD Warrior</div>
                <div style={{ fontSize: '14px', color: user.plan === 'pro' ? 'var(--accent-success)' : 'var(--text-secondary)' }}>
                  {user.plan === 'pro' ? '‚≠ê Pro Plan' : 'Free Trial'}
                </div>
              </div>
            </div>

            {/* Settings button */}
            <button
              onClick={onSettings}
              style={{
                width: '100%',
                padding: '16px',
                background: 'var(--bg-card)',
                border: '1px solid var(--border-subtle)',
                borderRadius: 'var(--radius-lg)',
                color: 'var(--text-primary)',
                marginBottom: '16px',
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                gap: '12px'
              }}
            >
              <Icons.Settings />
              <span style={{ fontWeight: '500' }}>Settings</span>
              <span style={{ marginLeft: 'auto', color: 'var(--text-muted)' }}>‚Üí</span>
            </button>

            {/* Subscription */}
            {user.plan !== 'pro' && (
              <div style={{
                background: 'linear-gradient(135deg, var(--accent-primary)20, var(--accent-glow)20)',
                border: '1px solid var(--accent-primary)',
                borderRadius: 'var(--radius-lg)',
                padding: '20px',
                marginBottom: '24px'
              }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '12px' }}>
                  <Icons.Crown />
                  <span style={{ fontWeight: '600' }}>Upgrade to Pro</span>
                </div>
                <p style={{ color: 'var(--text-secondary)', marginBottom: '16px', fontSize: '14px' }}>
                  Unlimited AI calls, priority features, support the developer!
                </p>
                <button
                  onClick={onUpgrade}
                  style={{
                    width: '100%',
                    padding: '14px',
                    background: 'linear-gradient(135deg, var(--accent-primary), var(--accent-glow))',
                    border: 'none',
                    borderRadius: 'var(--radius-md)',
                    color: 'white',
                    fontSize: '16px',
                    fontWeight: '600',
                    cursor: 'pointer'
                  }}
                >
                  $5/month ‚Äî Support & Unlock
                </button>
              </div>
            )}

            {/* Community */}
            <div style={{ background: 'var(--bg-card)', borderRadius: 'var(--radius-lg)', padding: '20px' }}>
              <h3 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '16px' }}>Community</h3>
              <a 
                href="https://discord.gg/YOUR_DISCORD" 
                target="_blank"
                style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '12px',
                  padding: '12px',
                  background: 'var(--bg-elevated)',
                  borderRadius: 'var(--radius-md)',
                  color: 'var(--text-primary)',
                  textDecoration: 'none',
                  marginBottom: '8px'
                }}
              >
                <span>üí¨</span> Join Discord
              </a>
              <a 
                href="mailto:fomagency@gmail.com"
                style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '12px',
                  padding: '12px',
                  background: 'var(--bg-elevated)',
                  borderRadius: 'var(--radius-md)',
                  color: 'var(--text-primary)',
                  textDecoration: 'none'
                }}
              >
                <span>‚úâÔ∏è</span> Email Ihor
              </a>
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // PROJECTS VIEW
    // ============================================
    const ProjectsView = ({ tasks }) => {
      const projects = {};
      tasks.forEach(t => {
        if (!projects[t.project]) projects[t.project] = [];
        projects[t.project].push(t);
      });

      if (Object.keys(projects).length === 0) {
        return (
          <div style={{ textAlign: 'center', padding: '60px 20px' }}>
            <div style={{ fontSize: '48px', marginBottom: '16px' }}>üìÅ</div>
            <h3 style={{ marginBottom: '8px' }}>No projects yet</h3>
            <p style={{ color: 'var(--text-muted)' }}>Add a task to create your first project</p>
          </div>
        );
      }

      return (
        <div>
          {Object.entries(projects).map(([project, projectTasks]) => {
            const completed = projectTasks.filter(t => t.completed).length;
            const percent = Math.round((completed / projectTasks.length) * 100);
            
            return (
              <div key={project} style={{
                background: 'var(--bg-card)',
                borderRadius: 'var(--radius-lg)',
                padding: '16px',
                marginBottom: '12px',
                border: '1px solid var(--border-subtle)'
              }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <div>
                    <h3 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '4px' }}>{project}</h3>
                    <p style={{ color: 'var(--text-secondary)', fontSize: '13px' }}>
                      {completed}/{projectTasks.length} completed
                    </p>
                  </div>
                  <div style={{
                    width: '48px',
                    height: '48px',
                    borderRadius: '50%',
                    background: `conic-gradient(var(--accent-primary) ${percent * 3.6}deg, var(--bg-elevated) 0deg)`,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                  }}>
                    <div style={{
                      width: '40px',
                      height: '40px',
                      borderRadius: '50%',
                      background: 'var(--bg-card)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontSize: '11px',
                      fontWeight: '600'
                    }}>
                      {percent}%
                    </div>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      );
    };

    // ============================================
    // MAIN APP
    // ============================================
    const App = () => {
      // State
      const [tasks, setTasks] = useState(() => {
        const saved = localStorage.getItem('neurodone_tasks');
        return saved ? JSON.parse(saved) : [];
      });
      const [tab, setTab] = useState('today');
      const [selectedDate, setSelectedDate] = useState(new Date());
      const [showProfile, setShowProfile] = useState(false);
      const [showSettings, setShowSettings] = useState(false);
      const [showCelebration, setShowCelebration] = useState(false);
      const [settings, setSettings] = useState(() => {
        const saved = localStorage.getItem('neurodone_settings');
        return saved ? JSON.parse(saved) : { voiceMode: 'select' };
      });
      const [user] = useState(() => ({
        plan: localStorage.getItem('neurodone_plan') || 'trial'
      }));

      // Save tasks
      useEffect(() => {
        localStorage.setItem('neurodone_tasks', JSON.stringify(tasks));
      }, [tasks]);

      // Save settings
      useEffect(() => {
        localStorage.setItem('neurodone_settings', JSON.stringify(settings));
      }, [settings]);

      // Register SW
      useEffect(() => {
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('/sw.js');
        }
      }, []);

      // Filter tasks
      const todayTasks = tasks.filter(t => !t.completed && (isToday(t.deadline) || isPast(t.deadline)));
      const calendarTasks = tasks.filter(t => isSameDay(t.deadline, selectedDate));

      // Handlers
      const handleAddTask = (task) => {
        console.log('[App] Adding task:', task);
        setTasks(prev => [task, ...prev]);
      };

      const handleAddTasks = (newTasks) => {
        console.log('[App] Adding multiple tasks:', newTasks);
        setTasks(prev => [...newTasks, ...prev]);
      };

      const handleToggleChunk = (taskId, chunkId) => {
        setTasks(tasks.map(t => 
          t.id === taskId 
            ? { ...t, chunks: t.chunks.map(c => c.id === chunkId ? { ...c, completed: !c.completed } : c) }
            : t
        ));
      };

      const handleCompleteTask = (taskId) => {
        setShowCelebration(true);
        setTasks(tasks.map(t => t.id === taskId ? { ...t, completed: true } : t));
      };

      const stats = parser.getStats();

      return (
        <div style={{ height: '100%', display: 'flex', flexDirection: 'column', paddingTop: 'var(--safe-top)' }}>
          {/* Header */}
          <header style={{ padding: '20px', paddingBottom: '12px' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <div>
                <p style={{ fontSize: '13px', color: 'var(--text-muted)', marginBottom: '4px' }}>
                  {new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}
                </p>
                <h1 style={{ fontSize: '28px', fontWeight: '700' }}>
                  {tab === 'today' ? 'Today' : tab === 'calendar' ? 'Calendar' : 'Projects'}
                </h1>
              </div>
              {tab === 'today' && todayTasks.length > 0 && (
                <div style={{ 
                  padding: '6px 12px', 
                  background: 'var(--bg-card)', 
                  borderRadius: 'var(--radius-sm)', 
                  fontSize: '13px',
                  border: '1px solid var(--border-subtle)'
                }}>
                  <span style={{ color: 'var(--accent-primary)', fontWeight: '600' }}>{todayTasks.length}</span> tasks
                </div>
              )}
            </div>
          </header>

          {/* Main content */}
          <main style={{ flex: 1, overflow: 'auto', padding: '0 20px', paddingBottom: '180px' }}>
            {/* Today Tab */}
            {tab === 'today' && (
              todayTasks.length === 0 ? (
                <div style={{ textAlign: 'center', padding: '60px 20px' }}>
                  <div style={{ fontSize: '48px', marginBottom: '16px' }}>üéâ</div>
                  <h2 style={{ fontSize: '20px', fontWeight: '600', marginBottom: '8px' }}>All clear!</h2>
                  <p style={{ color: 'var(--text-secondary)' }}>Tap the mic to add your first task</p>
                </div>
              ) : (
                todayTasks.map(task => (
                  <TaskCard 
                    key={task.id} 
                    task={task} 
                    onToggleChunk={handleToggleChunk}
                    onComplete={handleCompleteTask}
                  />
                ))
              )
            )}

            {/* Calendar Tab */}
            {tab === 'calendar' && (
              <>
                <Calendar 
                  tasks={tasks} 
                  selectedDate={selectedDate} 
                  onSelectDate={setSelectedDate} 
                />
                <h2 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '16px' }}>
                  {getRelativeDay(selectedDate)}
                </h2>
                {calendarTasks.length === 0 ? (
                  <div style={{ textAlign: 'center', padding: '40px', color: 'var(--text-muted)' }}>
                    <p>No tasks for this day</p>
                  </div>
                ) : (
                  calendarTasks.map(task => (
                    <TaskCard 
                      key={task.id} 
                      task={task} 
                      onToggleChunk={handleToggleChunk}
                      onComplete={handleCompleteTask}
                    />
                  ))
                )}
              </>
            )}

            {/* Projects Tab */}
            {tab === 'projects' && <ProjectsView tasks={tasks} />}
          </main>

          {/* Voice Input */}
          <VoiceInput 
            onAddTask={handleAddTask}
            onAddTasks={handleAddTasks}
            voiceMode={settings.voiceMode}
            isPaid={user.plan === 'pro'}
          />

          {/* Bottom Nav */}
          <BottomNav 
            activeTab={tab} 
            onTabChange={setTab} 
            onProfile={() => setShowProfile(true)}
          />

          {/* Profile */}
          {showProfile && (
            <ProfilePage 
              user={user}
              onClose={() => setShowProfile(false)}
              onUpgrade={() => {
                if (window.Paddle) {
                  window.Paddle.Checkout.open({ product: 'YOUR_PADDLE_ID' });
                } else {
                  alert('Payment loading... try again');
                }
              }}
              onSettings={() => {
                setShowProfile(false);
                setShowSettings(true);
              }}
            />
          )}

          {/* Settings */}
          {showSettings && (
            <SettingsPage 
              settings={settings}
              onUpdate={setSettings}
              onClose={() => setShowSettings(false)}
              stats={stats}
            />
          )}

          {/* Celebration */}
          <Celebration show={showCelebration} onDone={() => setShowCelebration(false)} />
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>

  <script src="https://cdn.paddle.com/paddle/paddle.js"></script>
  <script>
    if (window.Paddle) Paddle.Setup({ vendor: 12345 });
  </script>
</body>
</html>
